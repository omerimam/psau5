# -*- coding: utf-8 -*-
"""App.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15xSzM5rKsNfw8oqk_JqC9NzmD89_74p_
"""

# =========================
import streamlit as st
from datetime import date, timedelta
import sqlite3
import pandas as pd
from sentence_transformers import SentenceTransformer, util
from gtts import gTTS
from io import BytesIO

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø«ÙŠÙ… Ù„Ù„Ù‡ÙˆØ§ØªÙ
st.set_page_config(
    page_title="Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ",
    layout="wide",
    initial_sidebar_state="expanded"
)

st.markdown("""
<style>
body { background-color: #f4f4f9; }
h1,h2,h3 { color: #003366; }
.stTable td, .stTable th { text-align: center; font-size:14px;}
.stButton>button { background-color: #0055cc; color: white; font-size: 16px; border-radius: 10px; padding: 8px 16px; }
.stButton>button:hover { background-color: #003366; color: #ffffff; }
</style>
""", unsafe_allow_html=True)

# =========================
# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
@st.cache_resource
def init_db():
    conn = sqlite3.connect(":memory:", check_same_thread=False)
    cur = conn.cursor()
    cur.executescript("""
    CREATE TABLE Students (
        StudentID INTEGER PRIMARY KEY AUTOINCREMENT,
        Username TEXT UNIQUE,
        Password TEXT,
        FullName TEXT,
        Department TEXT
    );
    CREATE TABLE Schedules (
        ScheduleID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Day TEXT,
        StartTime TEXT,
        EndTime TEXT,
        Subject TEXT,
        Room TEXT
    );
    CREATE TABLE Tasks (
        TaskID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Title TEXT,
        DueDate TEXT,
        EstHours REAL,
        Priority TEXT,
        Done INTEGER DEFAULT 0
    );
    """)
    return conn, cur

@st.cache_data
def seed_demo(cur):
    cur.execute("INSERT INTO Students (Username, Password, FullName, Department) VALUES (?,?,?,?)",
                ("ahmed","1234","Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯","Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨"))
    today = date.today()
    cur.executemany("INSERT INTO Schedules (StudentID, Day, StartTime, EndTime, Subject, Room) VALUES (?,?,?,?,?,?)", [
        (1,"Ø§Ù„Ø£Ø­Ø¯","09:00","11:00","Ø¨Ø±Ù…Ø¬Ø©","A101"),
        (1,"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","10:00","12:00","Ø±ÙŠØ§Ø¶ÙŠØ§Øª","B201"),
        (1,"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","11:00","13:00","Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","A102"),
        (1,"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","09:00","11:00","ÙÙŠØ²ÙŠØ§Ø¡","C101"),
        (1,"Ø§Ù„Ø®Ù…ÙŠØ³","10:00","12:00","Ù†Ø¸Ù… ØªØ´ØºÙŠÙ„","C301")
    ])
    cur.executemany("INSERT INTO Tasks (StudentID, Title, DueDate, EstHours, Priority) VALUES (?,?,?,?,?)", [
        (1,"Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§ÙŠØ«ÙˆÙ†","%s"%(today + timedelta(days=3)),6.0,"High"),
        (1,"ÙˆØ§Ø¬Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª","%s"%(today + timedelta(days=1)),2.0,"Medium"),
        (1,"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","%s"%(today + timedelta(days=7)),4.0,"Low"),
        (1,"ØªØ¬Ù‡ÙŠØ² Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡","%s"%(today + timedelta(days=2)),3.0,"High")
    ])

# =========================
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
def authenticate(cur, username, password):
    cur.execute("SELECT StudentID, FullName, Department FROM Students WHERE Username=? AND Password=?", (username, password))
    return cur.fetchone()

def fetch_schedule(cur, student_id):
    cur.execute("SELECT Day, StartTime, EndTime, Subject, Room FROM Schedules WHERE StudentID=? ORDER BY Day, StartTime", (student_id,))
    return cur.fetchall()

def fetch_tasks(cur, student_id):
    cur.execute("SELECT TaskID, Title, DueDate, EstHours, Priority, Done FROM Tasks WHERE StudentID=? ORDER BY DueDate", (student_id,))
    return cur.fetchall()

def update_task_done(cur, task_id):
    cur.execute("UPDATE Tasks SET Done=1 WHERE TaskID=?", (task_id,))

# =========================
# Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ
@st.cache_resource
def init_embeddings():
    model = SentenceTransformer('all-MiniLM-L6-v2')
    return model

def semantic_search(query, tasks, model):
    if not tasks:
        return []
    task_texts = [t[1] for t in tasks]
    embeddings = model.encode(task_texts, convert_to_tensor=True)
    query_emb = model.encode(query, convert_to_tensor=True)
    hits = util.semantic_search(query_emb, embeddings, top_k=3)
    results = [tasks[h['corpus_id']] for h in hits[0]]
    return results

# =========================
# Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ Ø¹Ø¨Ø± gTTS
def speak(text):
    tts = gTTS(text, lang='ar')
    mp3_fp = BytesIO()
    tts.write_to_fp(mp3_fp)
    mp3_fp.seek(0)
    st.audio(mp3_fp, format="audio/mp3")

# =========================
# Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
def main():
    st.title("ğŸ“˜ Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ")

    # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if "db_init" not in st.session_state:
        conn, cur = init_db()
        seed_demo(cur)
        conn.commit()
        st.session_state.conn = conn
        st.session_state.cur = cur
        st.session_state.db_init = True

    cur = st.session_state.cur

    # ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
    if "student" not in st.session_state:
        with st.form("login_form"):
            username = st.text_input("ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            password = st.text_input("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
            submit = st.form_submit_button("Ø¯Ø®ÙˆÙ„")
            if submit:
                auth = authenticate(cur, username, password)
                if auth:
                    st.session_state.student = {"id": auth[0], "name": auth[1], "dept": auth[2]}
                    st.success(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {auth[1]} ğŸ‘‹")
                else:
                    st.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
        return

    student_id = st.session_state.student["id"]

    st.sidebar.title(f"ğŸ‘‹ Ø£Ù‡Ù„Ø§ {st.session_state.student['name']}")
    st.sidebar.subheader("Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª")
    feature = st.sidebar.radio("Ø§Ø®ØªØ± Ù…ÙŠØ²Ø©", [
        "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
        "Ø§Ù„Ù…Ù‡Ø§Ù…",
        "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ù…",
        "Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ",
        "Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ",
        "Google Calendar"
    ])

    tasks = fetch_tasks(cur, student_id)
    schedule = fetch_schedule(cur, student_id)

    model = init_embeddings()

    if feature == "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹":
        st.subheader("ğŸ—“ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹")
        st.table(pd.DataFrame(schedule, columns=["Ø§Ù„ÙŠÙˆÙ…","Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ù†","Ø§Ù„Ø³Ø§Ø¹Ø© Ø¥Ù„Ù‰","Ø§Ù„Ù…Ø§Ø¯Ø©","Ø§Ù„ØºØ±ÙØ©"]))

    elif feature == "Ø§Ù„Ù…Ù‡Ø§Ù…":
        st.subheader("âœ… Ø§Ù„Ù…Ù‡Ø§Ù…")
        st.table(pd.DataFrame(tasks, columns=["ID","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©","Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©","ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²"]))

    elif feature == "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ù…":
        st.subheader("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©")
        for t in tasks:
            if not t[5]:
                if st.button(f"ØªÙ… Ø¥Ù†Ø¬Ø§Ø²: {t[1]}", key=t[0]):
                    update_task_done(cur, t[0])
                    st.success(f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©: {t[1]}")

    elif feature == "Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ":
        st.subheader("ğŸ” Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù‡Ø§Ù…")
        query = st.text_input("Ø§ÙƒØªØ¨ Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‡Ù…Ø©")
        if query:
            results = semantic_search(query, tasks, model)
            for r in results:
                st.info(f"{r[1]} â€” ØªØ³Ù„ÙŠÙ…: {r[2]}")
                if st.button(f"ğŸ”Š Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù…Ù‡Ù…Ø©: {r[1]}", key=f"audio{r[0]}"):
                    speak(r[1])

    elif feature == "Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ":
        st.subheader("ğŸ¤ Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ")
        text_to_speak = st.text_area("Ø§ÙƒØªØ¨ Ù†Øµ Ù„ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù„ØµÙˆØª")
        if st.button("ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"):
            speak(text_to_speak)

    elif feature == "Google Calendar":
        st.subheader("ğŸ“… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰ Google Calendar")
        for t in tasks:
            if not t[5]:
                gcal_link = f"https://calendar.google.com/calendar/render?action=TEMPLATE&text={t[1]}&dates={t[2].replace('-','')}T090000Z/{t[2].replace('-','')}T100000Z"
                st.markdown(f"[â• Ø¥Ø¶Ø§ÙØ© {t[1]}]( {gcal_link} )", unsafe_allow_html=True)

if __name__ == "__main__":
    main()
